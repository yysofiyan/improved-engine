<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <system.webServer>
        <defaultDocument>
            <files>
                <clear />
                <add value="index.php" />
            </files>
        </defaultDocument>
        <rewrite>
            <rules>
                <!-- HTTPS Redirect -->
                <rule name="HTTP to HTTPS" stopProcessing="true">
                    <match url="(.*)" />
                    <conditions>
                        <add input="{HTTPS}" pattern="^OFF$" />
                    </conditions>
                    <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
                </rule>

                <!-- Block Gambling Sites -->
                <rule name="Block Gambling Referrers" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_REFERER}"
                            pattern="(slot-online|gacor|rtp-slot|judi-slot|slot88|maxwin|anti-rungkad|bosku|totoslot|dewa365|pragmaticplay|spadegaming|habanero|joker123|ioncuan|mpo007)" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <rule name="Block Gambling Query Strings" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{QUERY_STRING}"
                            pattern="(slot|gacor|rtp|judi|maxwin|toto)([^a-z]|$)" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <rule name="Block Gambling Bots" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_USER_AGENT}"
                            pattern="(SlotMachine|BotJudi|GacorScanner|DewaLive)" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <!-- Laravel Rules -->
                <rule name="Laravel Force public">
                    <match url="(.*)" ignoreCase="false" />
                    <action type="Rewrite" url="public/{R:1}" />
                </rule>
                <rule name="Laravel Routes" stopProcessing="true">
                    <conditions>
                        <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
                        <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
                    </conditions>
                    <match url="^" ignoreCase="false" />
                    <action type="Rewrite" url="public/index.php" />
                </rule>

                <!-- Tambahan keamanan -->
                <rule name="Block SQL Injection" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{QUERY_STRING}"
                            pattern="(union\s+select|sleep\(|benchmark\(|sqlmap)" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <rule name="Prevent Image Hotlinking" stopProcessing="true">
                    <match url=".*\.(gif|jpg|jpeg|png)$" />
                    <conditions>
                        <add input="{HTTP_REFERER}" pattern="^$" negate="true" />
                        <add input="{HTTP_REFERER}" pattern="^https?://(www\.)?(situs-anda\.com|cdn\.situs-anda\.net)" negate="true" />
                    </conditions>
                    <action type="Rewrite" url="/blocked.png" />
                </rule>

                <!-- Untuk proteksi rate limiting (anti DDoS): -->
                <rule name="Rate Limiting" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_X_REAL_IP}" pattern=".*" />
                        <add input="{CACHE_URL}" pattern="^(https?)://" />
                        <add input="{RATE_LIMIT_{C:1}_{HTTP_X_REAL_IP}}" pattern="(.+)"
                            negate="true" />
                    </conditions>
                    <serverVariables>
                        <set name="RATE_LIMIT_{C:1}_{HTTP_X_REAL_IP}" value="1" />
                    </serverVariables>
                    <action type="Rewrite" url="{R:0}" />
                </rule>

                <!-- Enhanced Gambling Protection -->
                <rule name="Block Gambling Referrers v2" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_REFERER}" 
                            pattern="(slot|judi|gacor|maxwin|casino|togel|pragmatic|pg\s*soft|zeus|deposit|dana|betting|slot\s*online|slot\s*gacor|slot\s*maxwin|slot\s*pragmatic|slot\s*thailand|slot\s*russia|slot\s*filipina|slot\s*eropa|slot\s*jepang|slot\s*deposit|slot\s*dana|slot\s*88|slot\s*777|slot\s*303|joker\s*123|joker\s*gaming|spadegaming|habanero|no\s*limit\s*city|gates\s*of\s*olympus|starlight\s*princess|gates\s*of\s*gatotkaca|demo\s*slot|demo\s*scatter|scatter\s*hitam|spaceman\s*slot|sbobet\s*indonesia|situs\s*sbobet|judi\s*bola\s*online|slot\s*online\s*terbaik|daftar\s*slot\s*gacor|daftar\s*slot\s*maxwin|daftar\s*akun\s*gacor|situs\s*slot\s*gacor|server\s*slot\s*gacor|slot\s*88|slot\s*nuke\s*gaming|slot\s*idn|slot\s*4d|agen\s*slot|garansi\s*kekalahan|bonus\s*new\s*member|bandar\s*slot|game\s*slot|situs\s*slot|pola\s*slot|scatter\s*selayar|bo\s*slot|bonus\s*slot|deposit\s*slot\s*minimal|deposit\s*slot\s*online|robopragma|robopg|cheat\s*slot|slot\s*mudah|mahjong|olympus\s*slot|link\s*robo|gampang\s*menang|sbobet\s*indonesia|situs\s*sbobet|judi\s*bola\s*online|slot\s*online\s*terbaik|daftar\s*slot\s*gacor|daftar\s*slot\s*maxwin|daftar\s*akun\s*gacor|situs\s*slot\s*gacor|server\s*slot\s*gacor|slot\s*88|slot\s*nuke\s*gaming|slot\s*idn|slot\s*4d|agen\s*slot|garansi\s*kekalahan|bonus\s*new\s*member|bandar\s*slot|game\s*slot|situs\s*slot|pola\s*slot|scatter\s*selayar|bo\s*slot|bonus\s*slot|deposit\s*slot\s*minimal|deposit\s*slot\s*online|robopragma|robopg|cheat\s*slot|slot\s*mudah|mahjong|olympus\s*slot|link\s*robo|gampang\s*menang)([^a-z]|\.(net|xyz|online|com|id|org))"
                            ignoreCase="true" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" statusDescription="Akses Ditolak - Situs Judi Terdeteksi" />
                </rule>

                <!-- Spam Backlink Protection -->
                <rule name="Block Spam Backlinks" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_REFERER}" 
                            pattern="(semprot\.com|bokep|vcs\.biz|blogspot\.com\/(?!official-blog))" 
                            ignoreCase="true" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <!-- Enhanced User Agent Block -->
                <rule name="Block Bad Bots v2" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_USER_AGENT}" 
                            pattern="(AhrefsBot|MJ12bot|DotBot|SeznamBot|spbot|WebDataStats|XoviBot|Zoominfo)" 
                            ignoreCase="true" />
                    </conditions>
                    <action type="CustomResponse" statusCode="403" />
                </rule>

                <!-- Allow Search Engines -->
                <rule name="Allow Search Engines" stopProcessing="true">
                    <match url=".*" />
                    <conditions>
                        <add input="{HTTP_USER_AGENT}" 
                            pattern="(Googlebot|Bingbot|YandexBot|DuckDuckBot|Applebot|Baiduspider)" 
                            ignoreCase="true" />
                    </conditions>
                    <action type="None" />
                </rule>

                <conditions logicalGrouping="MatchAll">
                    <add input="{HTTP_REFERER}" pattern="(situs-aman.com|trusted-domain.net)" negate="true" />
                </conditions>
            </rules>
        </rewrite>
        <httpProtocol>
            <customHeaders>
                <add name="Content-Security-Policy"
                    value="default-src 'self'; 
                            script-src 'self' https://cdn.jsdelivr.net https://code.jquery.com https://stackpath.bootstrapcdn.com 'unsafe-inline'; 
                            style-src 'self' https://fonts.googleapis.com https://cdnjs.cloudflare.com 'unsafe-inline'; 
                            font-src 'self' https://fonts.gstatic.com https://use.fontawesome.com; 
                            img-src 'self' data: https:; 
                            connect-src 'self' https://api.situs-anda.com; 
                            frame-src 'none'; 
                            form-action 'self'" />
                <add name="X-Content-Type-Options" value="nosniff" />
                <add name="X-Frame-Options" value="SAMEORIGIN" />
                <add name="X-XSS-Protection" value="1; mode=block" />
                <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
                <add name="Permissions-Policy" value="geolocation=(), camera=(), microphone=()" />
            </customHeaders>
        </httpProtocol>

        <security>
            <requestFiltering>
                <!-- Block spammy query params -->
                <denyQueryStringSequences>
                    <add sequence="utm_" />
                    <add sequence="ref=" />
                    <add sequence="?amp" />
                </denyQueryStringSequences>
            </requestFiltering>
        </security>
    </system.webServer>
    <location path=".env">
        <system.webServer>
            <security>
                <requestFiltering>
                    <hiddenSegments>
                        <add segment=".env" />
                    </hiddenSegments>
                </requestFiltering>
            </security>
        </system.webServer>
    </location>
</configuration>